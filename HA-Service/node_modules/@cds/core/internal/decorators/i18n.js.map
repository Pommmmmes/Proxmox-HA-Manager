{"version":3,"file":"i18n.js","sources":["../../../../src/internal/decorators/i18n.ts"],"sourcesContent":["/*\n * Copyright (c) 2016-2023 VMware, Inc. All Rights Reserved.\n * This software is released under MIT license.\n * The full license information can be found in LICENSE in the root directory of this project.\n */\nimport { property } from './property.js';\nimport { GlobalStateService } from '../services/global.service.js';\nimport { I18nService } from '../services/i18n.service.js';\nimport { isNilOrEmpty, mergeObjects, objectNaiveDeepEquals } from '../utils/identity.js';\nimport { LogService } from '../services/log.service.js';\n// Legacy TS Decorator\nfunction legacyI18n(descriptor, protoOrDescriptor, name) {\n    // NOTE: ALWAYS GOES HERE IN STORYBOOK (A.K.A. TS RUNTIME)\n    const desc = Object.defineProperty(protoOrDescriptor, name, descriptor);\n    return property({ type: Object, attribute: 'cds-i18n' })(desc, name);\n    // NOTE: REFLECT DOES NOTHING FOR US HERE\n}\n// TC39 Decorators proposal\nfunction standardI18n(descriptor, element) {\n    const desc = {\n        kind: 'method',\n        placement: 'prototype',\n        key: element.key,\n        descriptor,\n    };\n    return property({ type: Object })(desc);\n}\n/**\n * A property decorator which accesses a set of string values for use\n * inside the element's template. The values can be overridden at runtime\n * by changing the property value that's reflected through the attribute value.\n *\n * @example\n *\n *     class MyElement {\n *       @i18n()\n *       i18n = {\n *         \"open\" : \"Open my element\",\n *         \"close\" : \"Close my element\"\n *       };\n *     }\n *\n */\nexport function i18n() {\n    return (protoOrDescriptor, name) => {\n        const targetConnectedCallback = protoOrDescriptor.connectedCallback;\n        const targetDisconnectedCallback = protoOrDescriptor.disconnectedCallback;\n        function connectedCallback() {\n            protoOrDescriptor.__i18nSub = GlobalStateService.stateUpdates.subscribe(update => {\n                if (update.key === 'i18nRegistry') {\n                    this.requestUpdate(name);\n                }\n            });\n            if (targetConnectedCallback) {\n                targetConnectedCallback.apply(this);\n            }\n        }\n        function disconnectedCallback() {\n            protoOrDescriptor.__i18nSub.unsubscribe();\n            if (targetDisconnectedCallback) {\n                targetDisconnectedCallback.apply(this);\n            }\n        }\n        protoOrDescriptor.connectedCallback = connectedCallback;\n        protoOrDescriptor.disconnectedCallback = disconnectedCallback;\n        const descriptor = {\n            get() {\n                const i18nObj = mergeObjects(I18nService.keys[this.__i18nKey], this.__i18n || {});\n                return I18nService.hydrate(i18nObj, this);\n            },\n            set(value) {\n                const newValues = getI18nValues(value, this);\n                const testKey = I18nService.findKey(newValues);\n                const strat = getI18nUpdateStrategy(testKey || '', this.__i18nKey, newValues, this.__i18n);\n                if (typeof strat.key !== 'undefined') {\n                    this.__i18nKey = strat.key + '';\n                }\n                if (typeof strat.values !== 'undefined') {\n                    this.__i18n = { ...strat.values };\n                }\n                if (strat.update === true) {\n                    this.requestUpdate();\n                }\n                this.requestUpdate(name);\n            },\n            enumerable: true,\n            configurable: true,\n        };\n        return name !== undefined\n            ? legacyI18n(descriptor, protoOrDescriptor, name)\n            : standardI18n(descriptor, protoOrDescriptor);\n    };\n}\nexport function getI18nValues(values, component) {\n    if (isNilOrEmpty(values)) {\n        let returnVal = {};\n        if (component.hasAttribute('cds-i18n')) {\n            const stringVal = component.getAttribute('cds-i18n') + '';\n            if (isNilOrEmpty(stringVal)) {\n                returnVal = {};\n            }\n            else {\n                try {\n                    returnVal = JSON.parse(stringVal);\n                }\n                catch {\n                    LogService.warn('Clarity i18n: Invalid JSON passed to cds-i18n');\n                    returnVal = {};\n                }\n            }\n        }\n        return returnVal;\n    }\n    else {\n        return values;\n    }\n}\nexport function getI18nUpdateStrategy(newKey, oldKey, newValues, oldValues) {\n    if (!isNilOrEmpty(newKey)) {\n        if (newKey === oldKey) {\n            return { update: false, values: {} };\n        }\n        else {\n            return { update: true, key: newKey, values: {} };\n        }\n    }\n    else if (!objectNaiveDeepEquals(newValues, oldValues)) {\n        return { update: true, values: newValues };\n    }\n    return { update: false };\n}\n"],"names":["i18n","protoOrDescriptor","name","targetConnectedCallback","connectedCallback","targetDisconnectedCallback","disconnectedCallback","__i18nSub","GlobalStateService","stateUpdates","subscribe","update","key","this","requestUpdate","apply","unsubscribe","descriptor","get","i18nObj","mergeObjects","I18nService","keys","__i18nKey","__i18n","hydrate","set","value","newValues","getI18nValues","strat","getI18nUpdateStrategy","findKey","values","enumerable","configurable","undefined","desc","Object","defineProperty","property","type","attribute","legacyI18n","element","kind","placement","standardI18n","component","isNilOrEmpty","returnVal","hasAttribute","stringVal","getAttribute","JSON","parse","LogService","warn","newKey","oldKey","oldValues","objectNaiveDeepEquals"],"mappings":"+TA2CO,SAASA,IACZ,MAAO,CAACC,EAAmBC,KACvB,MAAMC,EAA0BF,EAAkBG,kBAC5CC,EAA6BJ,EAAkBK,qBAiBrDL,EAAkBG,kBAhBlB,WACIH,EAAkBM,UAAYC,EAAmBC,aAAaC,WAAUC,IACjD,iBAAfA,EAAOC,KACPC,KAAKC,cAAcZ,MAGvBC,GACAA,EAAwBY,MAAMF,OAUtCZ,EAAkBK,qBAPlB,WACIL,EAAkBM,UAAUS,cACxBX,GACAA,EAA2BU,MAAMF,OAKzC,MAAMI,EAAa,CACfC,MACI,MAAMC,EAAUC,EAAaC,EAAYC,KAAKT,KAAKU,WAAYV,KAAKW,QAAU,IAC9E,OAAOH,EAAYI,QAAQN,EAASN,OAExCa,IAAIC,GACA,MAAMC,EAAYC,EAAcF,EAAOd,MAEjCiB,EAAQC,EADEV,EAAYW,QAAQJ,IACW,GAAIf,KAAKU,UAAWK,EAAWf,KAAKW,aAC1D,IAAdM,EAAMlB,MACbC,KAAKU,UAAYO,EAAMlB,IAAM,SAEL,IAAjBkB,EAAMG,SACbpB,KAAKW,OAAS,IAAKM,EAAMG,UAER,IAAjBH,EAAMnB,QACNE,KAAKC,gBAETD,KAAKC,cAAcZ,IAEvBgC,YAAY,EACZC,cAAc,GAElB,YAAgBC,IAATlC,EA7Ef,SAAoBe,EAAYhB,EAAmBC,GAE/C,MAAMmC,EAAOC,OAAOC,eAAetC,EAAmBC,EAAMe,GAC5D,OAAOuB,EAAS,CAAEC,KAAMH,OAAQI,UAAW,YAApCF,CAAkDH,EAAMnC,GA2ErDyC,CAAW1B,EAAYhB,EAAmBC,GAvExD,SAAsBe,EAAY2B,GAC9B,MAAMP,EAAO,CACTQ,KAAM,SACNC,UAAW,YACXlC,IAAKgC,EAAQhC,IACbK,WAAAA,GAEJ,OAAOuB,EAAS,CAAEC,KAAMH,QAAjBE,CAA2BH,GAiExBU,CAAa9B,EAAYhB,IAGhC,SAAS4B,EAAcI,EAAQe,GAClC,GAAIC,EAAahB,GAAS,CACtB,IAAIiB,EAAY,GAChB,GAAIF,EAAUG,aAAa,YAAa,CACpC,MAAMC,EAAYJ,EAAUK,aAAa,YAAc,GACvD,GAAIJ,EAAaG,GACbF,EAAY,QAGZ,IACIA,EAAYI,KAAKC,MAAMH,GAE3B,MACII,EAAWC,KAAK,iDAChBP,EAAY,IAIxB,OAAOA,EAGP,OAAOjB,EAGR,SAASF,EAAsB2B,EAAQC,EAAQ/B,EAAWgC,GAC7D,OAAKX,EAAaS,GAQRG,EAAsBjC,EAAWgC,GAGpC,CAAEjD,QAAQ,GAFN,CAAEA,QAAQ,EAAMsB,OAAQL,GAR3B8B,IAAWC,EACJ,CAAEhD,QAAQ,EAAOsB,OAAQ,IAGzB,CAAEtB,QAAQ,EAAMC,IAAK8C,EAAQzB,OAAQ"}